<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PLAY.G 쇼핑분석 - 1~200위 실시간 랭킹</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Noto Sans KR',-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f7f8fb;color:#111827}
    .header{position:sticky;top:0;background:#ffffffd9;backdrop-filter:blur(10px);border-bottom:1px solid #e5e7eb;z-index:50}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    .brand{display:flex;align-items:center;gap:12px}
    .brand h1{font-size:20px;color:#4f46e5}
    .brand small{color:#6b7280}
    .controls{display:flex;flex-wrap:wrap;gap:12px;margin-top:12px;align-items:center}
    .tabs{display:flex;background:#f3f4f6;border-radius:10px;padding:4px}
    .tab{padding:10px 14px;border:0;background:transparent;border-radius:8px;font-weight:700;color:#374151;cursor:pointer}
    .tab.active{background:#4f46e5;color:#fff}
    select,input{padding:10px 12px;border:1px solid #e5e7eb;border-radius:8px}
    .stats{display:flex;gap:12px;margin:12px 0;flex-wrap:wrap}
    .stat{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px 16px}
    .stat .n{font-size:18px;font-weight:800;color:#4f46e5}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(270px,1fr));gap:16px;padding:16px 0}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;overflow:hidden;transition:.2s}
    .card:hover{transform:translateY(-3px);box-shadow:0 8px 20px rgba(0,0,0,.05)}
    .rank{position:absolute;margin:10px;padding:6px 10px;border-radius:9999px;background:#ef4444;color:#fff;font-weight:800}
    .imgwrap{position:relative}
    .img{width:100%;height:220px;object-fit:cover;cursor:pointer;background:#f3f4f6}
    .body{padding:14px}
    .title{font-size:15px;font-weight:700;line-height:1.4;margin-bottom:8px;cursor:pointer}
    .title:hover{color:#4f46e5}
    .price{font-size:18px;font-weight:800;color:#ef4444;margin-bottom:6px}
    .meta{display:flex;justify-content:space-between;color:#6b7280;font-size:13px;margin-bottom:10px}
    .actions{display:flex;gap:8px}
    .btn{flex:1;padding:10px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
    .primary{background:#4f46e5;color:#fff}
    .secondary{background:#f3f4f6;color:#111827}
    .pg{display:flex;gap:8px;justify-content:center;margin:16px 0}
    .pg button{padding:8px 12px;border-radius:8px;border:1px solid #e5e7eb;background:#fff;cursor:pointer}
    .pg .act{background:#4f46e5;color:#fff;border-color:#4f46e5}
    .loading{display:flex;flex-direction:column;gap:6px;align-items:center;justify-content:center;color:#6b7280;padding:40px}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:100}
    .panel{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:min(920px,92%);max-height:86vh;overflow:auto;background:#fff;border-radius:14px}
    .panel header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #eee;padding:14px 18px}
    .panel .content{padding:16px 18px}
    .close{background:none;border:0;font-size:28px;cursor:pointer;color:#6b7280}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:9999px;background:#f3f4f6;color:#374151;font-size:12px;font-weight:700}
    @media(max-width:768px){.img{height:200px}}
  </style>
</head>
<body>
  <div class="header">
    <div class="container">
      <div class="brand">
        <i class="fa-solid fa-chart-line" style="color:#4f46e5;font-size:20px"></i>
        <h1>PLAY.G 쇼핑 분석</h1>
        <small>네이버/쿠팡/기타 · 1~200위 실시간 · 분석보고서</small>
      </div>
      <div class="controls">
        <div class="tabs">
          <button class="tab active" data-p="naver">네이버쇼핑</button>
          <button class="tab" data-p="coupang" id="coupangTab">쿠팡</button>
          <button class="tab" data-p="other" id="otherTab">기타</button>
        </div>
        <select id="category">
          <option value="">전체 카테고리</option>
          <option>전자제품</option><option>패션의류</option><option>생활용품</option><option>식품</option>
          <option>화장품</option><option>도서</option><option>취미게임</option><option>육아용품</option>
          <option>자동차</option><option>스포츠</option><option>건강식품</option><option>가구인테리어</option>
        </select>
        <select id="sort">
          <option value="rank">🏆 인기순</option>
          <option value="sim">⭐ 추천순(정확도순)</option>
          <option value="asc">💰 낮은가격순</option>
          <option value="dsc">💎 높은가격순</option>
        </select>
        <input id="q" placeholder="검색어(선택)"/>
        <span class="badge" id="status">실시간 데이터</span>
      </div>
      <div class="stats">
        <div class="stat"><div class="n" id="totalN">0</div><div>상품수</div></div>
        <div class="stat"><div class="n" id="pageN">1</div><div>현재 페이지</div></div>
        <div class="stat"><div class="n" id="upd">--:--</div><div>업데이트</div></div>
      </div>
    </div>
  </div>

  <main class="container">
    <div id="loading" class="loading" style="display:none">
      <i class="fa-solid fa-spinner fa-spin fa-2xl"></i>
      <div>실시간 데이터를 불러오는 중...</div>
    </div>
    <div id="grid" class="grid"></div>
    <div id="pg" class="pg"></div>
  </main>

  <div id="modal" class="modal" onclick="if(event.target===this)closeModal()">
    <div class="panel">
      <header>
        <strong>📊 상품 분석보고서</strong>
        <button class="close" onclick="closeModal()">&times;</button>
      </header>
      <div id="mContent" class="content"></div>
    </div>
  </div>

  <script>
    const grid = document.getElementById('grid');
    const pg = document.getElementById('pg');
    const loading = document.getElementById('loading');
    const totalN = document.getElementById('totalN');
    const pageN = document.getElementById('pageN');
    const upd = document.getElementById('upd');
    const statusBadge = document.getElementById('status');

    let currentPlatform = 'naver';
    let all = [];
    let view = [];
    let page = 1;
    const perPage = 20;
    let coupangAvailable = true;

    // 탭 이벤트
    document.querySelectorAll('.tab').forEach(b=>{
      b.onclick=()=>{
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        currentPlatform = b.dataset.p;
        page = 1;
        load();
      }
    });

    // 필터 이벤트
    document.getElementById('category').onchange = apply;
    document.getElementById('sort').onchange = apply;
    document.getElementById('q').oninput = debounce(apply, 400);

    // 초기 로드
    (async function init(){
      // 쿠팡 사용 가능 여부 체크
      try{
        const r = await fetch('/api/coupang?check=1');
        if(r.status===503){ coupangAvailable=false; document.getElementById('coupangTab').innerText='쿠팡(설정 필요)';}
      }catch{ coupangAvailable=false; document.getElementById('coupangTab').innerText='쿠팡(설정 필요)';}
      load();
      setInterval(()=>{ if(currentPlatform!=='other') load(false); }, 300000); // 5분마다 갱신
    })();

    async function load(showSpinner=true){
      if(currentPlatform==='coupang' && !coupangAvailable){
        statusBadge.textContent = '쿠팡 API 키 필요';
        all=[]; render(); return;
      }

      try{
        if(showSpinner) show(true);
        const q = (document.getElementById('q').value||'').trim();
        const category = document.getElementById('category').value || '';
        const sortSel = document.getElementById('sort').value;

        let data = { products:[] }, products=[];
        if(currentPlatform==='naver'){
          // 네이버 200위: 100개×2회로 구성
          const nSort = sortSel==='sim'||sortSel==='asc'||sortSel==='dsc' ? sortSel : 'sim';
          const url1 = `/api/naver?q=${encodeURIComponent(q||category||'인기상품')}&sort=${nSort}&start=1&display=100`;
          const url2 = `/api/naver?q=${encodeURIComponent(q||category||'인기상품')}&sort=${nSort}&start=101&display=100`;
          const [r1,r2] = await Promise.all([fetch(url1), fetch(url2)]);
          const [d1,d2] = await Promise.all([r1.json(), r2.json()]);
          products = [...(d1.products||[]), ...(d2.products||[])].slice(0,200);
          statusBadge.textContent='네이버 실시간';
        }else if(currentPlatform==='coupang'){
          const url = `/api/coupang?keyword=${encodeURIComponent(q||category||'인기상품')}&limit=200`;
          const r = await fetch(url);
          if(r.status===503){ coupangAvailable=false; document.getElementById('coupangTab').innerText='쿠팡(설정 필요)'; all=[]; render(); return; }
          const d = await r.json();
          products = (d.products||[]).slice(0,200);
          statusBadge.textContent='쿠팡 실시간';
        }else{
          // 기타(현재는 비활성 혹은 추후 확장)
          products = [];
          statusBadge.textContent='기타(준비중)';
        }

        // 순위 보정, 카테고리 필드 정규화
        products = products.map((p,i)=>({
          ...p,
          rank: i+1,
          displayImage: `/api/image?url=${encodeURIComponent(p.image||'')}`
        }));

        all = products;
        apply(true);
        updateTime();
      }catch(e){
        console.error(e);
        all=[]; render();
      }finally{
        show(false);
      }
    }

    function apply(resetPage){
      if(resetPage) page=1;
      const category = document.getElementById('category').value || '';
      const sortSel = document.getElementById('sort').value;
      const q = (document.getElementById('q').value||'').trim().toLowerCase();

      view = all.filter(p=>{
        const inCat = !category || (p.category1===category || p.category2===category || p.category3===category || p.category4===category || p.category===category);
        const inQ = !q || (p.title||'').toLowerCase().includes(q);
        return inCat && inQ;
      });

      if(sortSel==='asc') view.sort((a,b)=>(a.price||0)-(b.price||0));
      else if(sortSel==='dsc') view.sort((a,b)=>(b.price||0)-(a.price||0));
      else if(sortSel==='sim') view.sort((a,b)=>(b.rating||0)-(a.rating||0)); // 추천=정확도/평점 우선
      else view.sort((a,b)=>(a.rank||0)-(b.rank||0)); // 인기=API 반환 순

      render();
    }

    function render(){
      totalN.textContent = view.length;
      pageN.textContent = page;
      const start=(page-1)*perPage,end=start+perPage;
      const list=view.slice(start,end);

      if(!list.length){
        grid.innerHTML = '<div class="loading"><div>표시할 상품이 없습니다</div></div>';
        pg.innerHTML='';
        return;
      }

      grid.innerHTML = list.map(p=>`
        <div class="card">
          <div class="imgwrap">
            <span class="rank">${p.rank}위</span>
            <img class="img" src="${p.displayImage}" alt="${escapeHtml(p.title||'상품')}" onclick="openLink('${encodeURIComponent(p.link||'')}')"
                 onerror="this.src='https://via.placeholder.com/400x300?text=No+Image'"/>
          </div>
          <div class="body">
            <div class="title" onclick="openLink('${encodeURIComponent(p.link||'')}'))">${escapeHtml(p.title||'상품명 미확인')}</div>
            <div class="price">${p.price? formatPrice(p.price)+'원':'가격정보없음'}</div>
            <div class="meta">
              <span>${escapeHtml(p.mall||'쇼핑몰')}</span>
              <span>⭐ ${p.rating||'-'} (${formatCount(p.reviewCount||0)})</span>
            </div>
            <div class="actions">
              <button class="btn primary" onclick="openLink('${encodeURIComponent(p.link||'')}')"><i class="fa-solid fa-cart-shopping"></i> 구매하기</button>
              <button class="btn secondary" onclick="showReport('${escapeQuotes(p.title||'상품')}', ${p.rank||0}, '${currentPlatform}')"><i class="fa-solid fa-chart-column"></i> 분석보고서</button>
            </div>
          </div>
        </div>
      `).join('');

      // 페이지네이션
      const pages = Math.max(1, Math.ceil(view.length/perPage));
      let h='';
      const range = window.innerWidth<520 ? 1 : 2;
      const s = Math.max(1, page-range), e=Math.min(pages, page+range);
      if(page>1) h+=`<button onclick="goto(${page-1})">‹</button>`;
      for(let i=s;i<=e;i++) h+=`<button class="${i===page?'act':''}" onclick="goto(${i})">${i}</button>`;
      if(page<pages) h+=`<button onclick="goto(${page+1})">›</button>`;
      pg.innerHTML=h;
    }

    function goto(i){ page=i; render(); window.scrollTo({top:0,behavior:'smooth'}); }

    function openLink(encoded){
      const url = decodeURIComponent(encoded||'');
      if(url && (url.startsWith('http://')||url.startsWith('https://'))){
        window.open(url,'_blank','noopener,noreferrer');
      }else{
        alert('유효한 구매 링크가 없습니다.');
      }
    }

    async function showReport(title, rank, platform){
      const modal=document.getElementById('modal');
      const mContent=document.getElementById('mContent');
      modal.style.display='block';
      mContent.innerHTML = `<div class="loading"><i class="fa-solid fa-spinner fa-spin"></i><div>분석 생성 중...</div></div>`;
      try{
        const r = await fetch('/api/product-analysis',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({product:title,rank,platform})
        });
        const d = await r.json();
        mContent.innerHTML = renderAnalysis(d);
      }catch(e){
        mContent.innerHTML = `<div>분석을 불러오지 못했습니다. 잠시 후 다시 시도해주세요.</div>`;
      }
    }

    function renderAnalysis(d){
      const A = d.analysis||{};
      const sec = (t,body)=>`
        <section style="margin-bottom:16px;padding:12px;border:1px solid #eee;border-radius:10px;background:#fafafa">
          <h3 style="margin-bottom:6px;color:#4f46e5">${t}</h3>
          ${Array.isArray(body)? `<ul style="padding-left:18px">${body.map(x=>`<li>${escapeHtml(String(x))}</li>`).join('')}</ul>`:`
            <div>${Object.entries(body||{}).map(([k,v])=>`<div><strong>${escapeHtml(k)}:</strong> ${escapeHtml(String(v))}</div>`).join('')}</div>`}
        </section>`;
      return `
        <div style="margin-bottom:8px"><strong>제품명:</strong> ${escapeHtml(d.product||'')}</div>
        ${sec('1) 시장 포지셔닝', A.marketPositioning||{})}
        ${sec('2) 제품 퍼포먼스 요약', A.performance||{})}
        ${sec('3) 시즌별 판매 추이', A.seasonalTrends||{})}
        ${sec('4) 개선·혁신 포인트', A.improvements||{})}
        ${sec('5) 벤치마킹 & 확장 전략', A.benchmarking||{})}
        ${sec('6) 신제품 출시 최종의견', A.finalOpinion||{})}
        ${sec('7) 판매자 정확한 정보', A.sellerInfo||{})}
      `;
    }

    function closeModal(){ document.getElementById('modal').style.display='none'; }

    function show(b){ loading.style.display=b?'flex':'none'; grid.style.opacity=b?.5:1; }

    function formatPrice(n){ return (n||0).toString().replace(/\B(?=(\d{3})+(?!\d))/g,','); }
    function formatCount(n){ return n>9999? (Math.round(n/100)/10)+'만' : n.toLocaleString(); }
    function updateTime(){
      const now=new Date(); upd.textContent=String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0');
    }
    function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(this,a),ms);} }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }
    function escapeQuotes(s){ return String(s).replace(/['"]/g, ''); }
  </script>
</body>
</html>
