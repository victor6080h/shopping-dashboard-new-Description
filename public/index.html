<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PLAY.G ì‡¼í•‘ë¶„ì„ - 1~200ìœ„ ì‹¤ì‹œê°„ ë­í‚¹</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Noto Sans KR',-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f7f8fb;color:#111827}
    .header{position:sticky;top:0;background:#ffffffd9;backdrop-filter:blur(10px);border-bottom:1px solid #e5e7eb;z-index:50}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    .brand{display:flex;align-items:center;gap:12px}
    .brand h1{font-size:20px;color:#4f46e5}
    .brand small{color:#6b7280}
    .controls{display:flex;flex-wrap:wrap;gap:12px;margin-top:12px;align-items:center}
    .tabs{display:flex;background:#f3f4f6;border-radius:10px;padding:4px}
    .tab{padding:10px 14px;border:0;background:transparent;border-radius:8px;font-weight:700;color:#374151;cursor:pointer}
    .tab.active{background:#4f46e5;color:#fff}
    select,input{padding:10px 12px;border:1px solid #e5e7eb;border-radius:8px}
    .stats{display:flex;gap:12px;margin:12px 0;flex-wrap:wrap}
    .stat{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px 16px}
    .stat .n{font-size:18px;font-weight:800;color:#4f46e5}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(270px,1fr));gap:16px;padding:16px 0}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;overflow:hidden;transition:.2s}
    .card:hover{transform:translateY(-3px);box-shadow:0 8px 20px rgba(0,0,0,.05)}
    .rank{position:absolute;margin:10px;padding:6px 10px;border-radius:9999px;background:#ef4444;color:#fff;font-weight:800}
    .imgwrap{position:relative}
    .img{width:100%;height:220px;object-fit:cover;cursor:pointer;background:#f3f4f6}
    .body{padding:14px}
    .title{font-size:15px;font-weight:700;line-height:1.4;margin-bottom:8px;cursor:pointer}
    .title:hover{color:#4f46e5}
    .price{font-size:18px;font-weight:800;color:#ef4444;margin-bottom:6px}
    .meta{display:flex;justify-content:space-between;color:#6b7280;font-size:13px;margin-bottom:10px}
    .actions{display:flex;gap:8px}
    .btn{flex:1;padding:10px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
    .primary{background:#4f46e5;color:#fff}
    .secondary{background:#f3f4f6;color:#111827}
    .pg{display:flex;gap:8px;justify-content:center;margin:16px 0}
    .pg button{padding:8px 12px;border-radius:8px;border:1px solid #e5e7eb;background:#fff;cursor:pointer}
    .pg .act{background:#4f46e5;color:#fff;border-color:#4f46e5}
    .loading{display:flex;flex-direction:column;gap:6px;align-items:center;justify-content:center;color:#6b7280;padding:40px}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:100}
    .panel{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:min(920px,92%);max-height:86vh;overflow:auto;background:#fff;border-radius:14px}
    .panel header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #eee;padding:14px 18px}
    .panel .content{padding:16px 18px}
    .close{background:none;border:0;font-size:28px;cursor:pointer;color:#6b7280}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:9999px;background:#f3f4f6;color:#374151;font-size:12px;font-weight:700}
    @media(max-width:768px){.img{height:200px}}
  </style>
</head>
<body>
  <div class="header">
    <div class="container">
      <div class="brand">
        <i class="fa-solid fa-chart-line" style="color:#4f46e5;font-size:20px"></i>
        <h1>PLAY.G ì‡¼í•‘ ë¶„ì„</h1>
        <small>ë„¤ì´ë²„/ì¿ íŒ¡/ê¸°íƒ€ Â· 1~200ìœ„ ì‹¤ì‹œê°„ Â· ë¶„ì„ë³´ê³ ì„œ</small>
      </div>
      <div class="controls">
        <div class="tabs">
          <button class="tab active" data-p="naver">ë„¤ì´ë²„ì‡¼í•‘</button>
          <button class="tab" data-p="coupang" id="coupangTab">ì¿ íŒ¡</button>
          <button class="tab" data-p="other" id="otherTab">ê¸°íƒ€</button>
        </div>
        <select id="category">
          <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
          <option>ì „ìì œí’ˆ</option><option>íŒ¨ì…˜ì˜ë¥˜</option><option>ìƒí™œìš©í’ˆ</option><option>ì‹í’ˆ</option>
          <option>í™”ì¥í’ˆ</option><option>ë„ì„œ</option><option>ì·¨ë¯¸ê²Œì„</option><option>ìœ¡ì•„ìš©í’ˆ</option>
          <option>ìë™ì°¨</option><option>ìŠ¤í¬ì¸ </option><option>ê±´ê°•ì‹í’ˆ</option><option>ê°€êµ¬ì¸í…Œë¦¬ì–´</option>
        </select>
        <select id="sort">
          <option value="rank">ğŸ† ì¸ê¸°ìˆœ</option>
          <option value="sim">â­ ì¶”ì²œìˆœ(ì •í™•ë„ìˆœ)</option>
          <option value="asc">ğŸ’° ë‚®ì€ê°€ê²©ìˆœ</option>
          <option value="dsc">ğŸ’ ë†’ì€ê°€ê²©ìˆœ</option>
        </select>
        <input id="q" placeholder="ê²€ìƒ‰ì–´(ì„ íƒ)"/>
        <span class="badge" id="status">ì‹¤ì‹œê°„ ë°ì´í„°</span>
      </div>
      <div class="stats">
        <div class="stat"><div class="n" id="totalN">0</div><div>ìƒí’ˆìˆ˜</div></div>
        <div class="stat"><div class="n" id="pageN">1</div><div>í˜„ì¬ í˜ì´ì§€</div></div>
        <div class="stat"><div class="n" id="upd">--:--</div><div>ì—…ë°ì´íŠ¸</div></div>
      </div>
    </div>
  </div>

  <main class="container">
    <div id="loading" class="loading" style="display:none">
      <i class="fa-solid fa-spinner fa-spin fa-2xl"></i>
      <div>ì‹¤ì‹œê°„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
    <div id="grid" class="grid"></div>
    <div id="pg" class="pg"></div>
  </main>

  <div id="modal" class="modal" onclick="if(event.target===this)closeModal()">
    <div class="panel">
      <header>
        <strong>ğŸ“Š ìƒí’ˆ ë¶„ì„ë³´ê³ ì„œ</strong>
        <button class="close" onclick="closeModal()">&times;</button>
      </header>
      <div id="mContent" class="content"></div>
    </div>
  </div>

  <script>
    const grid = document.getElementById('grid');
    const pg = document.getElementById('pg');
    const loading = document.getElementById('loading');
    const totalN = document.getElementById('totalN');
    const pageN = document.getElementById('pageN');
    const upd = document.getElementById('upd');
    const statusBadge = document.getElementById('status');

    let currentPlatform = 'naver';
    let all = [];
    let view = [];
    let page = 1;
    const perPage = 20;
    let coupangAvailable = true;

    // íƒ­ ì´ë²¤íŠ¸
    document.querySelectorAll('.tab').forEach(b=>{
      b.onclick=()=>{
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        currentPlatform = b.dataset.p;
        page = 1;
        load();
      }
    });

    // í•„í„° ì´ë²¤íŠ¸
    document.getElementById('category').onchange = apply;
    document.getElementById('sort').onchange = apply;
    document.getElementById('q').oninput = debounce(apply, 400);

    // ì´ˆê¸° ë¡œë“œ
    (async function init(){
      // ì¿ íŒ¡ ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ ì²´í¬
      try{
        const r = await fetch('/api/coupang?check=1');
        if(r.status===503){ coupangAvailable=false; document.getElementById('coupangTab').innerText='ì¿ íŒ¡(ì„¤ì • í•„ìš”)';}
      }catch{ coupangAvailable=false; document.getElementById('coupangTab').innerText='ì¿ íŒ¡(ì„¤ì • í•„ìš”)';}
      load();
      setInterval(()=>{ if(currentPlatform!=='other') load(false); }, 300000); // 5ë¶„ë§ˆë‹¤ ê°±ì‹ 
    })();

    async function load(showSpinner=true){
      if(currentPlatform==='coupang' && !coupangAvailable){
        statusBadge.textContent = 'ì¿ íŒ¡ API í‚¤ í•„ìš”';
        all=[]; render(); return;
      }

      try{
        if(showSpinner) show(true);
        const q = (document.getElementById('q').value||'').trim();
        const category = document.getElementById('category').value || '';
        const sortSel = document.getElementById('sort').value;

        let data = { products:[] }, products=[];
        if(currentPlatform==='naver'){
          // ë„¤ì´ë²„ 200ìœ„: 100ê°œÃ—2íšŒë¡œ êµ¬ì„±
          const nSort = sortSel==='sim'||sortSel==='asc'||sortSel==='dsc' ? sortSel : 'sim';
          const url1 = `/api/naver?q=${encodeURIComponent(q||category||'ì¸ê¸°ìƒí’ˆ')}&sort=${nSort}&start=1&display=100`;
          const url2 = `/api/naver?q=${encodeURIComponent(q||category||'ì¸ê¸°ìƒí’ˆ')}&sort=${nSort}&start=101&display=100`;
          const [r1,r2] = await Promise.all([fetch(url1), fetch(url2)]);
          const [d1,d2] = await Promise.all([r1.json(), r2.json()]);
          products = [...(d1.products||[]), ...(d2.products||[])].slice(0,200);
          statusBadge.textContent='ë„¤ì´ë²„ ì‹¤ì‹œê°„';
        }else if(currentPlatform==='coupang'){
          const url = `/api/coupang?keyword=${encodeURIComponent(q||category||'ì¸ê¸°ìƒí’ˆ')}&limit=200`;
          const r = await fetch(url);
          if(r.status===503){ coupangAvailable=false; document.getElementById('coupangTab').innerText='ì¿ íŒ¡(ì„¤ì • í•„ìš”)'; all=[]; render(); return; }
          const d = await r.json();
          products = (d.products||[]).slice(0,200);
          statusBadge.textContent='ì¿ íŒ¡ ì‹¤ì‹œê°„';
        }else{
          // ê¸°íƒ€(í˜„ì¬ëŠ” ë¹„í™œì„± í˜¹ì€ ì¶”í›„ í™•ì¥)
          products = [];
          statusBadge.textContent='ê¸°íƒ€(ì¤€ë¹„ì¤‘)';
        }

        // ìˆœìœ„ ë³´ì •, ì¹´í…Œê³ ë¦¬ í•„ë“œ ì •ê·œí™”
        products = products.map((p,i)=>({
          ...p,
          rank: i+1,
          displayImage: `/api/image?url=${encodeURIComponent(p.image||'')}`
        }));

        all = products;
        apply(true);
        updateTime();
      }catch(e){
        console.error(e);
        all=[]; render();
      }finally{
        show(false);
      }
    }

    function apply(resetPage){
      if(resetPage) page=1;
      const category = document.getElementById('category').value || '';
      const sortSel = document.getElementById('sort').value;
      const q = (document.getElementById('q').value||'').trim().toLowerCase();

      view = all.filter(p=>{
        const inCat = !category || (p.category1===category || p.category2===category || p.category3===category || p.category4===category || p.category===category);
        const inQ = !q || (p.title||'').toLowerCase().includes(q);
        return inCat && inQ;
      });

      if(sortSel==='asc') view.sort((a,b)=>(a.price||0)-(b.price||0));
      else if(sortSel==='dsc') view.sort((a,b)=>(b.price||0)-(a.price||0));
      else if(sortSel==='sim') view.sort((a,b)=>(b.rating||0)-(a.rating||0)); // ì¶”ì²œ=ì •í™•ë„/í‰ì  ìš°ì„ 
      else view.sort((a,b)=>(a.rank||0)-(b.rank||0)); // ì¸ê¸°=API ë°˜í™˜ ìˆœ

      render();
    }

    function render(){
      totalN.textContent = view.length;
      pageN.textContent = page;
      const start=(page-1)*perPage,end=start+perPage;
      const list=view.slice(start,end);

      if(!list.length){
        grid.innerHTML = '<div class="loading"><div>í‘œì‹œí•  ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤</div></div>';
        pg.innerHTML='';
        return;
      }

      grid.innerHTML = list.map(p=>`
        <div class="card">
          <div class="imgwrap">
            <span class="rank">${p.rank}ìœ„</span>
            <img class="img" src="${p.displayImage}" alt="${escapeHtml(p.title||'ìƒí’ˆ')}" onclick="openLink('${encodeURIComponent(p.link||'')}')"
                 onerror="this.src='https://via.placeholder.com/400x300?text=No+Image'"/>
          </div>
          <div class="body">
            <div class="title" onclick="openLink('${encodeURIComponent(p.link||'')}'))">${escapeHtml(p.title||'ìƒí’ˆëª… ë¯¸í™•ì¸')}</div>
            <div class="price">${p.price? formatPrice(p.price)+'ì›':'ê°€ê²©ì •ë³´ì—†ìŒ'}</div>
            <div class="meta">
              <span>${escapeHtml(p.mall||'ì‡¼í•‘ëª°')}</span>
              <span>â­ ${p.rating||'-'} (${formatCount(p.reviewCount||0)})</span>
            </div>
            <div class="actions">
              <button class="btn primary" onclick="openLink('${encodeURIComponent(p.link||'')}')"><i class="fa-solid fa-cart-shopping"></i> êµ¬ë§¤í•˜ê¸°</button>
              <button class="btn secondary" onclick="showReport('${escapeQuotes(p.title||'ìƒí’ˆ')}', ${p.rank||0}, '${currentPlatform}')"><i class="fa-solid fa-chart-column"></i> ë¶„ì„ë³´ê³ ì„œ</button>
            </div>
          </div>
        </div>
      `).join('');

      // í˜ì´ì§€ë„¤ì´ì…˜
      const pages = Math.max(1, Math.ceil(view.length/perPage));
      let h='';
      const range = window.innerWidth<520 ? 1 : 2;
      const s = Math.max(1, page-range), e=Math.min(pages, page+range);
      if(page>1) h+=`<button onclick="goto(${page-1})">â€¹</button>`;
      for(let i=s;i<=e;i++) h+=`<button class="${i===page?'act':''}" onclick="goto(${i})">${i}</button>`;
      if(page<pages) h+=`<button onclick="goto(${page+1})">â€º</button>`;
      pg.innerHTML=h;
    }

    function goto(i){ page=i; render(); window.scrollTo({top:0,behavior:'smooth'}); }

    function openLink(encoded){
      const url = decodeURIComponent(encoded||'');
      if(url && (url.startsWith('http://')||url.startsWith('https://'))){
        window.open(url,'_blank','noopener,noreferrer');
      }else{
        alert('ìœ íš¨í•œ êµ¬ë§¤ ë§í¬ê°€ ì—†ìŠµë‹ˆë‹¤.');
      }
    }

    async function showReport(title, rank, platform){
      const modal=document.getElementById('modal');
      const mContent=document.getElementById('mContent');
      modal.style.display='block';
      mContent.innerHTML = `<div class="loading"><i class="fa-solid fa-spinner fa-spin"></i><div>ë¶„ì„ ìƒì„± ì¤‘...</div></div>`;
      try{
        const r = await fetch('/api/product-analysis',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({product:title,rank,platform})
        });
        const d = await r.json();
        mContent.innerHTML = renderAnalysis(d);
      }catch(e){
        mContent.innerHTML = `<div>ë¶„ì„ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</div>`;
      }
    }

    function renderAnalysis(d){
      const A = d.analysis||{};
      const sec = (t,body)=>`
        <section style="margin-bottom:16px;padding:12px;border:1px solid #eee;border-radius:10px;background:#fafafa">
          <h3 style="margin-bottom:6px;color:#4f46e5">${t}</h3>
          ${Array.isArray(body)? `<ul style="padding-left:18px">${body.map(x=>`<li>${escapeHtml(String(x))}</li>`).join('')}</ul>`:`
            <div>${Object.entries(body||{}).map(([k,v])=>`<div><strong>${escapeHtml(k)}:</strong> ${escapeHtml(String(v))}</div>`).join('')}</div>`}
        </section>`;
      return `
        <div style="margin-bottom:8px"><strong>ì œí’ˆëª…:</strong> ${escapeHtml(d.product||'')}</div>
        ${sec('1) ì‹œì¥ í¬ì§€ì…”ë‹', A.marketPositioning||{})}
        ${sec('2) ì œí’ˆ í¼í¬ë¨¼ìŠ¤ ìš”ì•½', A.performance||{})}
        ${sec('3) ì‹œì¦Œë³„ íŒë§¤ ì¶”ì´', A.seasonalTrends||{})}
        ${sec('4) ê°œì„ Â·í˜ì‹  í¬ì¸íŠ¸', A.improvements||{})}
        ${sec('5) ë²¤ì¹˜ë§ˆí‚¹ & í™•ì¥ ì „ëµ', A.benchmarking||{})}
        ${sec('6) ì‹ ì œí’ˆ ì¶œì‹œ ìµœì¢…ì˜ê²¬', A.finalOpinion||{})}
        ${sec('7) íŒë§¤ì ì •í™•í•œ ì •ë³´', A.sellerInfo||{})}
      `;
    }

    function closeModal(){ document.getElementById('modal').style.display='none'; }

    function show(b){ loading.style.display=b?'flex':'none'; grid.style.opacity=b?.5:1; }

    function formatPrice(n){ return (n||0).toString().replace(/\B(?=(\d{3})+(?!\d))/g,','); }
    function formatCount(n){ return n>9999? (Math.round(n/100)/10)+'ë§Œ' : n.toLocaleString(); }
    function updateTime(){
      const now=new Date(); upd.textContent=String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0');
    }
    function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(this,a),ms);} }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }
    function escapeQuotes(s){ return String(s).replace(/['"]/g, ''); }
  </script>
</body>
</html>
