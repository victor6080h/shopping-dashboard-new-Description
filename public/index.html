<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLAY.G 쇼핑분석</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; color: #333;
        }
        
        .container { 
            max-width: 1600px; margin: 0 auto; background: white; 
            border-radius: 20px; box-shadow: 0 25px 80px rgba(0,0,0,0.1); 
            overflow: hidden; margin: 15px auto;
        }
        
        .header { 
            background: linear-gradient(135deg, #FF6B6B 0%, #4ECDC4 100%); 
            color: white; padding: 25px; text-align: center; position: relative;
        }
        .header::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="75" cy="75" r="1" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }
        .header h1 { 
            font-size: 2.8em; margin-bottom: 8px; font-weight: 700; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3); position: relative; z-index: 1;
        }
        .header p { 
            font-size: 1.2em; opacity: 0.95; position: relative; z-index: 1;
            font-weight: 300;
        }

        .main-controls { 
            padding: 25px 30px; background: linear-gradient(to right, #f8f9fa, #e9ecef); 
            display: flex; gap: 20px; align-items: center; flex-wrap: wrap; 
            border-bottom: 3px solid #e9ecef;
        }
        .control-group { 
            display: flex; align-items: center; gap: 10px; 
            background: white; padding: 8px 15px; border-radius: 12px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .control-group label { 
            font-weight: 600; color: #495057; font-size: 14px; min-width: 60px;
        }
        select { 
            padding: 8px 12px; border: 2px solid #e9ecef; 
            border-radius: 8px; font-size: 14px; background: white;
            transition: all 0.3s ease; min-width: 120px;
        }
        select:focus { 
            outline: none; border-color: #4ECDC4; 
            box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.1);
        }
        
        .action-buttons { 
            margin-left: auto; display: flex; gap: 12px; 
        }
        .btn { 
            padding: 12px 24px; border: none; border-radius: 25px; 
            cursor: pointer; font-weight: 600; font-size: 14px;
            transition: all 0.3s ease; display: flex; align-items: center; gap: 8px;
        }
        .btn-primary { 
            background: linear-gradient(135deg, #4ECDC4, #44A08D); 
            color: white; box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
        }
        .btn-primary:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(78, 205, 196, 0.4);
        }
        .btn-secondary { 
            background: linear-gradient(135deg, #FF6B6B, #FF8E53); 
            color: white; box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }
        .btn-secondary:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        }

        .platform-tabs { 
            display: flex; background: #f1f3f4; 
        }
        .platform-tab { 
            flex: 1; padding: 18px 20px; background: #e9ecef; 
            border: none; cursor: pointer; font-size: 16px; font-weight: 600; 
            transition: all 0.3s ease; color: #6c757d; position: relative;
        }
        .platform-tab.active { 
            background: white; color: #495057; 
            box-shadow: 0 -3px 0 #04ECDC4 inset;
        }
        .platform-tab:hover:not(.active) { 
            background: #dee2e6; color: #495057;
        }

        .content { display: none; }
        .content.active { display: block; }

        .ranking-section { padding: 25px; }
        .stats-bar { 
            display: grid; grid-template-columns: 1fr auto; gap: 20px;
            padding: 20px; background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px; margin-bottom: 25px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        .stats-info { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
            gap: 20px;
        }
        .stat-item { text-align: center; }
        .stat-number { 
            font-size: 1.8em; font-weight: bold; 
            background: linear-gradient(135deg, #4ECDC4, #44A08D);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .stat-label { 
            font-size: 0.9em; color: #6c757d; margin-top: 5px; 
            font-weight: 500;
        }

        .sort-controls {
            display: flex; gap: 10px; margin-bottom: 20px; justify-content: center;
        }
        .sort-btn {
            padding: 8px 16px; border: 2px solid #e9ecef; background: white;
            border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500;
            transition: all 0.3s ease;
        }
        .sort-btn.active {
            background: #4ECDC4; color: white; border-color: #4ECDC4;
        }
        .sort-btn:hover:not(.active) {
            border-color: #4ECDC4; color: #4ECDC4;
        }

        .products-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
            gap: 20px; margin-top: 20px;
        }
        .product-card { 
            background: white; border: 1px solid #e9ecef; 
            border-radius: 16px; overflow: hidden; 
            transition: all 0.3s ease; cursor: pointer;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }
        .product-card:hover { 
            transform: translateY(-8px); 
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
            border-color: #4ECDC4;
        }
        .product-rank { 
            background: linear-gradient(135deg, #FF6B6B, #FF8E53); 
            color: white; padding: 10px 15px; font-weight: bold; 
            font-size: 1.1em; display: flex; align-items: center; gap: 8px;
        }
        .product-rank.top3 {
            background: linear-gradient(135deg, #FFD700, #FFA500);
        }
        .product-image { 
            width: 100%; height: 200px; background: #f8f9fa; 
            display: flex; align-items: center; justify-content: center;
            position: relative; overflow: hidden;
        }
        .product-image img { 
            width: 100%; height: 100%; object-fit: cover; 
            transition: transform 0.3s ease;
        }
        .product-card:hover .product-image img {
            transform: scale(1.05);
        }
        .product-info { padding: 18px; }
        .product-title { 
            font-weight: 600; margin-bottom: 10px; line-height: 1.4; 
            font-size: 1.05em; color: #2c3e50;
            display: -webkit-box; -webkit-line-clamp: 2; 
            -webkit-box-orient: vertical; overflow: hidden;
        }
        .product-pricing {
            margin-bottom: 12px;
        }
        .product-price { 
            font-size: 1.4em; font-weight: bold; color: #e74c3c; 
            margin-bottom: 4px;
        }
        .product-original-price {
            font-size: 0.9em; color: #6c757d; text-decoration: line-through;
            margin-right: 8px;
        }
        .product-discount {
            font-size: 0.9em; color: #e74c3c; font-weight: 600;
        }
        .product-meta { 
            display: flex; justify-content: space-between; align-items: center;
            font-size: 0.9em; color: #6c757d; margin-bottom: 8px;
        }
        .product-platform {
            padding: 4px 8px; border-radius: 12px; font-size: 0.8em;
            font-weight: 600; color: white;
        }
        .platform-naver { background: #00C73C; }
        .platform-coupang { background: #FF6600; }
        .platform-gmarket { background: #00A0FF; }
        .platform-auction { background: #FF6B35; }

        .loading { 
            text-align: center; padding: 60px 20px; 
        }
        .loading-spinner { 
            width: 50px; height: 50px; border: 4px solid #f3f3f3; 
            border-top: 4px solid #4ECDC4; border-radius: 50%; 
            animation: spin 1s linear infinite; margin: 0 auto 20px;
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }

        .error { 
            background: linear-gradient(135deg, #ffebee, #ffcdd2); 
            color: #c62828; padding: 25px; border-radius: 12px; 
            margin: 20px; border-left: 5px solid #e53935;
        }
        .error h3 {
            margin-bottom: 10px; color: #b71c1c;
        }

        @media (max-width: 768px) {
            .container { margin: 10px; border-radius: 15px; }
            .header h1 { font-size: 2.2em; }
            .main-controls { 
                flex-direction: column; align-items: stretch; gap: 15px;
                padding: 20px;
            }
            .action-buttons { 
                margin-left: 0; justify-content: center; 
            }
            .stats-info { 
                grid-template-columns: repeat(2, 1fr); gap: 15px; 
            }
            .products-grid { 
                grid-template-columns: 1fr; gap: 15px; 
            }
            .platform-tab {
                padding: 15px 10px; font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎮 PLAY.G 쇼핑분석</h1>
            <p>네이버, 쿠팡, 기타 플랫폼 통합 분석 대시보드</p>
        </div>

        <div class="main-controls">
            <div class="control-group">
                <label for="category">카테고리</label>
                <select id="category">
                    <option value="패션의류">👔 패션의류</option>
                    <option value="화장품/뷰티">💄 화장품/뷰티</option>
                    <option value="디지털/가전">📱 디지털/가전</option>
                    <option value="생활용품">🏠 생활용품</option>
                    <option value="식품/건강식품">🥗 식품/건강식품</option>
                    <option value="도서/음반">📚 도서/음반</option>
                    <option value="스포츠/레저">⚽ 스포츠/레저</option>
                    <option value="자동차용품">🚗 자동차용품</option>
                    <option value="유아/아동">👶 유아/아동</option>
                    <option value="반려동물">🐕 반려동물</option>
                    <option value="홈인테리어">🛋️ 홈인테리어</option>
                    <option value="문구/오피스">✏️ 문구/오피스</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="displayCount">표시개수</label>
                <select id="displayCount">
                    <option value="50">50개</option>
                    <option value="100" selected>100개</option>
                    <option value="150">150개</option>
                </select>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" onclick="refreshAllData()">
                    🔄 전체 새로고침
                </button>
                <button class="btn btn-secondary" onclick="downloadExcel()">
                    📊 엑셀 다운로드
                </button>
            </div>
        </div>

        <div class="platform-tabs">
            <button class="platform-tab active" onclick="switchPlatform('naver')">
                🟢 네이버쇼핑
            </button>
            <button class="platform-tab" onclick="switchPlatform('coupang')">
                🧡 쿠팡
            </button>
            <button class="platform-tab" onclick="switchPlatform('other')">
                🔵 기타 플랫폼
            </button>
        </div>

        <!-- 네이버쇼핑 섹션 -->
        <div id="naver-content" class="content active">
            <div class="ranking-section">
                <div class="stats-bar">
                    <div class="stats-info">
                        <div class="stat-item">
                            <div class="stat-number" id="naver-total">-</div>
                            <div class="stat-label">전체 상품수</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="naver-shown">-</div>
                            <div class="stat-label">표시 상품수</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="naver-category">-</div>
                            <div class="stat-label">현재 카테고리</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="naver-sort">-</div>
                            <div class="stat-label">정렬 방식</div>
                        </div>
                    </div>
                    <div style="text-align: right; color: #6c757d;">
                        <div style="font-size: 0.85em;">마지막 업데이트</div>
                        <div id="naver-updated" style="font-size: 0.9em;">-</div>
                    </div>
                </div>

                <div class="sort-controls">
                    <button class="sort-btn active" onclick="changeSortType('naver', 'popularity')">
                        🔥 실시간 인기순
                    </button>
                    <button class="sort-btn" onclick="changeSortType('naver', 'recommend')">
                        ⭐ 추천순
                    </button>
                </div>

                <div class="products-grid" id="naver-products">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>네이버쇼핑 데이터를 불러오는 중입니다...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 쿠팡 섹션 -->
        <div id="coupang-content" class="content">
            <div class="ranking-section">
                <div class="stats-bar">
                    <div class="stats-info">
                        <div class="stat-item">
                            <div class="stat-number" id="coupang-total">-</div>
                            <div class="stat-label">전체 상품수</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="coupang-shown">-</div>
                            <div class="stat-label">표시 상품수</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="coupang-category">-</div>
                            <div class="stat-label">현재 카테고리</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="coupang-sort">-</div>
                            <div class="stat-label">정렬 방식</div>
                        </div>
                    </div>
                    <div style="text-align: right; color: #6c757d;">
                        <div style="font-size: 0.85em;">마지막 업데이트</div>
                        <div id="coupang-updated" style="font-size: 0.9em;">-</div>
                    </div>
                </div>

                <div class="sort-controls">
                    <button class="sort-btn active" onclick="changeSortType('coupang', 'popularity')">
                        🔥 실시간 인기순
                    </button>
                    <button class="sort-btn" onclick="changeSortType('coupang', 'recommend')">
                        ⭐ 추천순
                    </button>
                </div>

                <div class="products-grid" id="coupang-products">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>쿠팡 데이터를 불러오는 중입니다...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 기타 플랫폼 섹션 -->
        <div id="other-content" class="content">
            <div class="ranking-section">
                <div class="main-controls" style="margin-bottom: 20px;">
                    <div class="control-group">
                        <label for="otherPlatform">플랫폼 선택</label>
                        <select id="otherPlatform">
                            <option value="gmarket">🔵 지마켓</option>
                            <option value="auction">🟠 옥션</option>
                            <option value="interpark">🔴 인터파크</option>
                            <option value="11st">🟣 11번가</option>
                            <option value="lotte">🟡 롯데온</option>
                            <option value="ssg">🟢 SSG</option>
                        </select>
                    </div>
                </div>

                <div class="stats-bar">
                    <div class="stats-info">
                        <div class="stat-item">
                            <div class="stat-number" id="other-total">-</div>
                            <div class="stat-label">전체 상품수</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="other-shown">-</div>
                            <div class="stat-label">표시 상품수</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="other-platform">-</div>
                            <div class="stat-label">현재 플랫폼</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="other-sort">-</div>
                            <div class="stat-label">정렬 방식</div>
                        </div>
                    </div>
                    <div style="text-align: right; color: #6c757d;">
                        <div style="font-size: 0.85em;">마지막 업데이트</div>
                        <div id="other-updated" style="font-size: 0.9em;">-</div>
                    </div>
                </div>

                <div class="sort-controls">
                    <button class="sort-btn active" onclick="changeSortType('other', 'popularity')">
                        🔥 실시간 인기순
                    </button>
                    <button class="sort-btn" onclick="changeSortType('other', 'recommend')">
                        ⭐ 추천순
                    </button>
                </div>

                <div class="products-grid" id="other-products">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>플랫폼 데이터를 불러오는 중입니다...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPlatform = 'naver';
        let sortTypes = {
            naver: 'popularity',
            coupang: 'popularity', 
            other: 'popularity'
        };

        // 플랫폼 전환
        function switchPlatform(platform) {
            document.querySelectorAll('.platform-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[onclick="switchPlatform('${platform}')"]`).classList.add('active');
            
            document.querySelectorAll('.content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${platform}-content`).classList.add('active');
            
            currentPlatform = platform;
            loadPlatformData(platform);
        }

        // 정렬 방식 변경
        function changeSortType(platform, sortType) {
            // 해당 플랫폼의 정렬 버튼 업데이트
            const section = document.getElementById(`${platform}-content`);
            section.querySelectorAll('.sort-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            section.querySelector(`[onclick="changeSortType('${platform}', '${sortType}')"]`).classList.add('active');
            
            sortTypes[platform] = sortType;
            loadPlatformData(platform);
        }

        // 플랫폼 데이터 로드
        async function loadPlatformData(platform) {
            const category = document.getElementById('category').value;
            const displayCount = document.getElementById('displayCount').value;
            const sortType = sortTypes[platform];
            
            const productsContainer = document.getElementById(`${platform}-products`);
            productsContainer.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>${getPlatformName(platform)} 데이터를 불러오는 중입니다...</p>
                </div>
            `;

            try {
                let apiUrl = '';
                let queryParams = `category=${encodeURIComponent(category)}&sortType=${sortType}&display=${displayCount}`;
                
                if (platform === 'naver') {
                    apiUrl = `/api/naver?${queryParams}`;
                } else if (platform === 'coupang') {
                    apiUrl = `/api/coupang?${queryParams}`;
                } else if (platform === 'other') {
                    const selectedPlatform = document.getElementById('otherPlatform').value;
                    apiUrl = `/api/other-platforms?platform=${selectedPlatform}&${queryParams}`;
                }

                const response = await fetch(apiUrl);
                const data = await response.json();
                
                if (data.success) {
                    displayProducts(platform, data);
                    updateStats(platform, data);
                } else {
                    throw new Error(data.error || '데이터 로드 실패');
                }
                
            } catch (error) {
                console.error(`${platform} 데이터 로드 오류:`, error);
                productsContainer.innerHTML = `
                    <div class="error">
                        <h3>❌ 데이터 로드 실패</h3>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="loadPlatformData('${platform}')" style="margin-top: 15px;">
                            다시 시도
                        </button>
                    </div>
                `;
            }
        }

        // 상품 데이터 표시
        function displayProducts(platform, data) {
            const container = document.getElementById(`${platform}-products`);
            
            if (!data.items || data.items.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: #6c757d;">
                        <div style="font-size: 3em; margin-bottom: 20px;">📦</div>
                        <h3>상품 데이터가 없습니다</h3>
                        <p>다른 카테고리를 선택해보세요</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = data.items.map(item => `
                <div class="product-card" onclick="openProductLink('${item.productUrl}', '${item.productName}')">
                    <div class="product-rank ${item.rank <= 3 ? 'top3' : ''}">
                        ${item.rank <= 3 ? '🏆' : '📍'} #${item.rank}
                    </div>
                    <div class="product-image">
                        ${item.imageUrl ? 
                            `<img src="${item.imageUrl}" alt="${item.productName}" onerror="this.style.display='none'">` : 
                            '<div style="color: #6c757d; font-size: 2em;">📦</div>'
                        }
                    </div>
                    <div class="product-info">
                        <div class="product-title">${item.productName}</div>
                        <div class="product-pricing">
                            <div class="product-price">${item.price}</div>
                            ${item.originalPrice && item.discountRate ? 
                                `<div>
                                    <span class="product-original-price">${item.originalPrice}</span>
                                    <span class="product-discount">${item.discountRate}% 할인</span>
                                </div>` : ''
                            }
                        </div>
                        <div class="product-meta">
                            <span class="product-platform platform-${item.platform}">
                                ${item.mallName || getPlatformName(platform)}
                            </span>
                            <span>${item.brand || ''}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 통계 업데이트
        function updateStats(platform, data) {
            document.getElementById(`${platform}-total`).textContent = data.total?.toLocaleString() || '0';
            document.getElementById(`${platform}-shown`).textContent = data.count?.toString() || '0';
            document.getElementById(`${platform}-category`).textContent = data.category || '-';
            document.getElementById(`${platform}-sort`).textContent = data.sortName || '-';
            document.getElementById(`${platform}-updated`).textContent = new Date().toLocaleString();
            
            // 기타 플랫폼의 경우 플랫폼명도 업데이트
            if (platform === 'other') {
                document.getElementById(`${platform}-platform`).textContent = data.platformName || '-';
            }
        }

        // 상품 링크 열기
        function openProductLink(url, productName) {
            if (url && url.trim() && url !== '#') {
                window.open(url, '_blank', 'noopener,noreferrer');
            } else {
                alert(`"${productName}" 상품의 구매 링크가 없습니다.`);
            }
        }

        // 플랫폼명 반환
        function getPlatformName(platform) {
            const names = {
                'naver': '네이버쇼핑',
                'coupang': '쿠팡',
                'other': '기타 플랫폼'
            };
            return names[platform] || platform;
        }

        // 전체 데이터 새로고침
        function refreshAllData() {
            loadPlatformData(currentPlatform);
        }

        // 엑셀 다운로드
        function downloadExcel() {
            const category = document.getElementById('category').value;
            const platform = currentPlatform;  
            const sortType = sortTypes[platform];
            
            const link = document.createElement('a');
            link.href = `/api/download-excel?category=${encodeURIComponent(category)}&platform=${platform}&sortType=${sortType}`;
            link.download = '';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 이벤트 리스너
        document.getElementById('category').addEventListener('change', refreshAllData);
        document.getElementById('displayCount').addEventListener('change', refreshAllData);
        document.getElementById('otherPlatform').addEventListener('change', () => {
            if (currentPlatform === 'other') {
                loadPlatformData('other');
            }
        });

        // 페이지 로드 시 초기 데이터 로드
        document.addEventListener('DOMContentLoaded', function() {
            loadPlatformData('naver');
        });
    </script>
</body>
</html>
